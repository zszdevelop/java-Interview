<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-beta.59" />
    <meta name="theme" content="VuePress Theme Hope" />
    <meta property="og:url" content="https://zszdevelop.github.io/java-study-gitbook/dependencies/mybatis/mybatis-y-datasource.html"><meta property="og:site_name" content="Java学习笔记"><meta property="og:title" content="MyBatis详解 - 数据源与连接池"><meta property="og:description" content="本文主要介绍MyBatis数据源和连接池相关的内容。 1. MyBatis数据源DataSource分类 MyBatis把数据源DataSource分为三种： UNPOOLED 不使用连接池的数据源; POOLED 使用连接池的数据源; JNDI 使用JNDI实现的数据源; 相应地，MyBatis内部分别定义了实现了java.sql.DataSourc..."><meta property="og:type" content="article"><meta property="og:updated_time" content="2023-02-20T13:42:31.000Z"><meta property="og:locale" content="zh-CN"><meta property="article:modified_time" content="2023-02-20T13:42:31.000Z"><script>
          var _hmt = _hmt || [];
          (function() {
            var hm = document.createElement("script");
            hm.src = "https://hm.baidu.com/hm.js?78dc0e0b4e3aedf643d6621778307a6f";
            var s = document.getElementsByTagName("script")[0]; 
            s.parentNode.insertBefore(hm, s);
          })();
      </script><title>MyBatis详解 - 数据源与连接池 | Java学习笔记</title><meta name="description" content="本文主要介绍MyBatis数据源和连接池相关的内容。 1. MyBatis数据源DataSource分类 MyBatis把数据源DataSource分为三种： UNPOOLED 不使用连接池的数据源; POOLED 使用连接池的数据源; JNDI 使用JNDI实现的数据源; 相应地，MyBatis内部分别定义了实现了java.sql.DataSourc...">
    <style>
      :root {
        --bg-color: #fff;
      }

      html[data-theme="dark"] {
        --bg-color: #1d2025;
      }

      html,
      body {
        background: var(--bg-color);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.querySelector("html").setAttribute("data-theme", "dark");
      }
    </script>
    <link rel="preload" href="/assets/style-21064aac.css" as="style"><link rel="stylesheet" href="/assets/style-21064aac.css">
    <link rel="modulepreload" href="/assets/app-891e5fab.js"><link rel="modulepreload" href="/assets/framework-0cf5f349.js"><link rel="modulepreload" href="/assets/mybatis-y-datasource.html-a8793c19.js"><link rel="modulepreload" href="/assets/mybatis-y-datasource.html-81fdbbf2.js">
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="skip-link sr-only">跳至主要內容</a><!--]--><div class="theme-container has-toc"><!--[--><!--[--><header class="navbar"><div class="navbar-left"><button class="toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><!--[--><!----><!--]--><a href="/" class="brand"><img class="logo" src="/logo.svg" alt="Java学习笔记"><!----><span class="site-name hide-in-pad">Java学习笔记</span></a><!--[--><!----><!--]--></div><div class="navbar-center"><!--[--><!----><!--]--><nav class="nav-links"><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="Java"><span class="title"><span class="icon iconfont icon-creative"></span>Java</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><a href="/java/base/Java-basis-oop.html" class="nav-link" aria-label="Java基础"><!---->Java基础<!----></a></li><li class="dropdown-item"><a href="/java/io/java-io-overview.html" class="nav-link" aria-label="Java IO"><!---->Java IO<!----></a></li><li class="dropdown-item"><a href="/java/collection/java-collection-overview.html" class="nav-link" aria-label="Java集合"><!---->Java集合<!----></a></li><li class="dropdown-item"><a href="/java/thread/java-thread-x-theorty.html" class="nav-link" aria-label="Java并发"><!---->Java并发<!----></a></li><li class="dropdown-item"><a href="/java/java8/java8-lambda.html" class="nav-link" aria-label="Java8"><!---->Java8<!----></a></li><li class="dropdown-item"><a href="/java/jvm/jvm-overview.html" class="nav-link" aria-label="JVM"><!---->JVM<!----></a></li></ul></button></div></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="数据库"><span class="title"><span class="icon iconfont icon-creative"></span>数据库</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><a href="/db/sql/sql-x-basic.html" class="nav-link" aria-label="数据库基础/SQL基础"><!---->数据库基础/SQL基础<!----></a></li><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>Sql数据库</span></h4><ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/db/mysql/sql-mysql-overview.html" class="nav-link" aria-label="Mysql"><!---->Mysql<!----></a></li><li class="dropdown-subitem"><a href="/db/oracle/oracle-b-sequence.html" class="nav-link" aria-label="Oracle"><!---->Oracle<!----></a></li><li class="dropdown-subitem"><a href="/db/dm/dm-operation-console.html" class="nav-link" aria-label="达梦"><!---->达梦<!----></a></li></ul></li><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>NoSql数据库</span></h4><ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/db/redis/db-redis-introduce.html" class="nav-link" aria-label="Redis"><!---->Redis<!----></a></li><li class="dropdown-subitem"><a href="/db/mongodb/mongo-x-basic.html" class="nav-link" aria-label="MongoDB"><!---->MongoDB<!----></a></li><li class="dropdown-subitem"><a href="/db/es/elasticsearch-x-introduce-1.html" class="nav-link" aria-label="Elasticsearch"><!---->Elasticsearch<!----></a></li><li class="dropdown-subitem"><a href="/db/neo4j/neo4j-x-tutorial.html" class="nav-link" aria-label="Neo4J"><!---->Neo4J<!----></a></li></ul></li></ul></button></div></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="框架|依赖"><span class="title"><span class="icon iconfont icon-creative"></span>框架|依赖</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>Spring</span></h4><ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/dependencies/spring/spring-overview.html" class="nav-link" aria-label="Spring"><!---->Spring<!----></a></li><li class="dropdown-subitem"><a href="/dependencies/spring-boot/springboot-x-overview.html" class="nav-link" aria-label="SpringBoot"><!---->SpringBoot<!----></a></li></ul></li><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>ORM</span></h4><ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/dependencies/mybatis/mybatis-y-arch.html" class="nav-link" aria-label="Mybatis"><!---->Mybatis<!----></a></li><li class="dropdown-subitem"><a href="/dependencies/mybatis-plus/mybatis-plus-x-gen-code.html" class="nav-link" aria-label="Mybatis-Plus"><!---->Mybatis-Plus<!----></a></li></ul></li><li class="dropdown-item"><a href="/dependencies/office/office-x-aspose.html" class="nav-link" aria-label="Office文档操作"><!---->Office文档操作<!----></a></li><li class="dropdown-item"><a href="/dependencies/cas/cas-x-overview.html" class="nav-link" aria-label="CAS单点登录"><!---->CAS单点登录<!----></a></li></ul></button></div></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="开发|测试"><span class="title"><span class="icon iconfont icon-creative"></span>开发|测试</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><a href="/develop/devlibrary/dev-lib-lombok.html" class="nav-link" aria-label="开发-常用类库"><span class="icon iconfont icon-creative"></span>开发-常用类库<!----></a></li><li class="dropdown-item"><a href="/develop/security/dev-security-x-injection.html" class="nav-link" aria-label="开发-安全"><span class="icon iconfont icon-creative"></span>开发-安全<!----></a></li><li class="dropdown-item"><a href="/develop/optimization/optimization-x-interface-optimization.html" class="nav-link" aria-label="开发 - 优化"><span class="icon iconfont icon-creative"></span>开发 - 优化<!----></a></li><li class="dropdown-item"><a href="/develop/style/dev-qt-code-style.html" class="nav-link" aria-label="开发 - 规范/风格"><span class="icon iconfont icon-creative"></span>开发 - 规范/风格<!----></a></li><li class="dropdown-item"><a href="/develop/test/ut-overview" class="nav-link" aria-label="测试"><span class="icon iconfont icon-creative"></span>测试<!----></a></li></ul></button></div></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="软件|部署"><span class="title"><span class="icon iconfont icon-creative"></span>软件|部署</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><a href="/deploy/docker/docker-basic-overview.html" class="nav-link" aria-label="Docker"><span class="icon iconfont icon-creative"></span>Docker<!----></a></li><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>消息队列</span></h4><ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/deploy/mq/mq-a-overview.html" class="nav-link" aria-label="消息队列"><!---->消息队列<!----></a></li><li class="dropdown-subitem"><a href="/deploy/mq-rabbitmq/rabbitmq-x-overview.html" class="nav-link" aria-label="RabbitMQ"><!---->RabbitMQ<!----></a></li><li class="dropdown-subitem"><a href="/deploy/mq-kafka/kafka-x-overview.html" class="nav-link" aria-label="Kafka"><!---->Kafka<!----></a></li></ul></li><li class="dropdown-item"><a href="/deploy/skywalking/skywalking-x-principle.html" class="nav-link" aria-label="Skywalking"><span class="icon iconfont icon-creative"></span>Skywalking<!----></a></li><li class="dropdown-item"><a href="/deploy/linux/linux-j-monitor-overview.html" class="nav-link" aria-label="Linux"><span class="icon iconfont icon-creative"></span>Linux<!----></a></li><li class="dropdown-item"><a href="/deploy/jenkins/jenkins-overview.html" class="nav-link" aria-label="Jenkins"><span class="icon iconfont icon-creative"></span>Jenkins<!----></a></li><li class="dropdown-item"><a href="/deploy/nginx/nginx-x-overview.html" class="nav-link" aria-label="Nginx"><span class="icon iconfont icon-creative"></span>Nginx<!----></a></li><li class="dropdown-item"><a href="/deploy/deploy/docker-basic-overview" class="nav-link" aria-label="部署"><span class="icon iconfont icon-creative"></span>部署<!----></a></li></ul></button></div></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="架构|系统"><span class="title"><span class="icon iconfont icon-creative"></span>架构|系统</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><a href="/arch/base/arch-basic.html" class="nav-link" aria-label="架构基础"><span class="icon iconfont icon-creative"></span>架构基础<!----></a></li><li class="dropdown-item"><a href="/arch/distributed/arch-id.html" class="nav-link" aria-label="分布式系统"><span class="icon iconfont icon-creative"></span>分布式系统<!----></a></li><li class="dropdown-item"><a href="/arch/microservices/ms-overview.html" class="nav-link" aria-label="微服务"><span class="icon iconfont icon-creative"></span>微服务<!----></a></li><li class="dropdown-item"><a href="/arch/minio/minio-concept.html" class="nav-link" aria-label="对象存储-Minio"><span class="icon iconfont icon-creative"></span>对象存储-Minio<!----></a></li><li class="dropdown-item"><a href="/arch/manage-system/manage-system-technical-selection.html" class="nav-link" aria-label="后台管理系统"><span class="icon iconfont icon-creative"></span>后台管理系统<!----></a></li><li class="dropdown-item"><a href="/arch/mall/mall-sku.html" class="nav-link" aria-label="商城设计"><span class="icon iconfont icon-creative"></span>商城设计<!----></a></li></ul></button></div></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="语言|平台"><span class="title"><span class="icon iconfont icon-creative"></span>语言|平台</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><a href="/language/frontend-layout/flex-layout-overview.html" class="nav-link" aria-label="前端"><span class="icon iconfont icon-creative"></span>前端<!----></a></li><li class="dropdown-item"><a href="/language/python/python-advantage.html" class="nav-link" aria-label="python"><span class="icon iconfont icon-creative"></span>python<!----></a></li><li class="dropdown-item"><a href="/language/weixin/wx-package-Optimization.html" class="nav-link" aria-label="微信"><span class="icon iconfont icon-creative"></span>微信<!----></a></li><li class="dropdown-item"><a href="/language/ai/knowledge-graph-build.html" class="nav-link" aria-label="AI人工智能"><span class="icon iconfont icon-creative"></span>AI人工智能<!----></a></li></ul></button></div></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="杂项|思考"><span class="title"><span class="icon iconfont icon-creative"></span>杂项|思考</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><a href="/think/deepImpression/redis-bigdata-slow-problem.html" class="nav-link" aria-label="印象深刻bug"><span class="icon iconfont icon-creative"></span>印象深刻bug<!----></a></li><li class="dropdown-item"><a href="/think/optimization/optimization-x-frequent-operation-db.html" class="nav-link" aria-label="优化"><span class="icon iconfont icon-creative"></span>优化<!----></a></li><li class="dropdown-item"><a href="/think/misc/misc-x-middleware.html" class="nav-link" aria-label="杂项"><span class="icon iconfont icon-creative"></span>杂项<!----></a></li></ul></button></div></div></nav><!--[--><!----><!--]--></div><div class="navbar-right"><!--[--><!----><!--]--><!----><div class="nav-item"><a class="repo-link" href="https://github.com/zszdevelop/java-study-gitbook" target="_blank" rel="noopener noreferrer" aria-label="GitHub"><svg xmlns="http://www.w3.org/2000/svg" class="icon github-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="github icon" style="width:1.25rem;height:1.25rem;vertical-align:middle;"><path d="M511.957 21.333C241.024 21.333 21.333 240.981 21.333 512c0 216.832 140.544 400.725 335.574 465.664 24.49 4.395 32.256-10.07 32.256-23.083 0-11.69.256-44.245 0-85.205-136.448 29.61-164.736-64.64-164.736-64.64-22.315-56.704-54.4-71.765-54.4-71.765-44.587-30.464 3.285-29.824 3.285-29.824 49.195 3.413 75.179 50.517 75.179 50.517 43.776 75.008 114.816 53.333 142.762 40.79 4.523-31.66 17.152-53.377 31.19-65.537-108.971-12.458-223.488-54.485-223.488-242.602 0-53.547 19.114-97.323 50.517-131.67-5.035-12.33-21.93-62.293 4.779-129.834 0 0 41.258-13.184 134.912 50.346a469.803 469.803 0 0 1 122.88-16.554c41.642.213 83.626 5.632 122.88 16.554 93.653-63.488 134.784-50.346 134.784-50.346 26.752 67.541 9.898 117.504 4.864 129.834 31.402 34.347 50.474 78.123 50.474 131.67 0 188.586-114.73 230.016-224.042 242.09 17.578 15.232 33.578 44.672 33.578 90.454v135.85c0 13.142 7.936 27.606 32.854 22.87C862.25 912.597 1002.667 728.747 1002.667 512c0-271.019-219.648-490.667-490.71-490.667z"></path></svg></a></div><div class="nav-item hide-in-mobile"><button id="appearance-switch"><svg xmlns="http://www.w3.org/2000/svg" class="icon auto-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="auto icon" style="display:block;"><path d="M512 992C246.92 992 32 777.08 32 512S246.92 32 512 32s480 214.92 480 480-214.92 480-480 480zm0-840c-198.78 0-360 161.22-360 360 0 198.84 161.22 360 360 360s360-161.16 360-360c0-198.78-161.22-360-360-360zm0 660V212c165.72 0 300 134.34 300 300 0 165.72-134.28 300-300 300z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon dark-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="dark icon" style="display:none;"><path d="M524.8 938.667h-4.267a439.893 439.893 0 0 1-313.173-134.4 446.293 446.293 0 0 1-11.093-597.334A432.213 432.213 0 0 1 366.933 90.027a42.667 42.667 0 0 1 45.227 9.386 42.667 42.667 0 0 1 10.24 42.667 358.4 358.4 0 0 0 82.773 375.893 361.387 361.387 0 0 0 376.747 82.774 42.667 42.667 0 0 1 54.187 55.04 433.493 433.493 0 0 1-99.84 154.88 438.613 438.613 0 0 1-311.467 128z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon light-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="light icon" style="display:none;"><path d="M952 552h-80a40 40 0 0 1 0-80h80a40 40 0 0 1 0 80zM801.88 280.08a41 41 0 0 1-57.96-57.96l57.96-58a41.04 41.04 0 0 1 58 58l-58 57.96zM512 752a240 240 0 1 1 0-480 240 240 0 0 1 0 480zm0-560a40 40 0 0 1-40-40V72a40 40 0 0 1 80 0v80a40 40 0 0 1-40 40zm-289.88 88.08-58-57.96a41.04 41.04 0 0 1 58-58l57.96 58a41 41 0 0 1-57.96 57.96zM192 512a40 40 0 0 1-40 40H72a40 40 0 0 1 0-80h80a40 40 0 0 1 40 40zm30.12 231.92a41 41 0 0 1 57.96 57.96l-57.96 58a41.04 41.04 0 0 1-58-58l58-57.96zM512 832a40 40 0 0 1 40 40v80a40 40 0 0 1-80 0v-80a40 40 0 0 1 40-40zm289.88-88.08 58 57.96a41.04 41.04 0 0 1-58 58l-57.96-58a41 41 0 0 1 57.96-57.96z"></path></svg></button></div><div id="docsearch-container"></div><!--[--><!----><!--]--><button class="toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span class="button-container"><span class="button-top"></span><span class="button-middle"></span><span class="button-bottom"></span></span></button></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow left"></span></div><aside class="sidebar"><!--[--><!----><!--]--><ul class="sidebar-links"><li><section class="sidebar-group"><button class="sidebar-heading clickable"><!----><span class="title">Spring</span><span class="arrow right"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><!----><span class="title">SpringBoot</span><span class="arrow right"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable active"><!----><span class="title">ORM-Mybatis</span><span class="arrow down"></span></button><ul class="sidebar-links"><li><!--[--><a href="/dependencies/mybatis/mybatis-y-arch.html" class="nav-link sidebar-link sidebar-page" aria-label="MyBatis详解 - 总体框架设计"><!---->MyBatis详解 - 总体框架设计<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/dependencies/mybatis/mybatis-y-init.html" class="nav-link sidebar-link sidebar-page" aria-label="MyBatis详解 - 初始化基本过程"><!---->MyBatis详解 - 初始化基本过程<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/dependencies/mybatis/mybatis-y-config-load.html" class="nav-link sidebar-link sidebar-page" aria-label="MyBatis详解 - 配置解析过程"><!---->MyBatis详解 - 配置解析过程<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/dependencies/mybatis/mybatis-y-config-list.html" class="nav-link sidebar-link sidebar-page" aria-label="MyBatis详解 - 官网配置清单"><!---->MyBatis详解 - 官网配置清单<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/dependencies/mybatis/mybatis-y-config-mapper.html" class="nav-link sidebar-link sidebar-page" aria-label="MyBatis详解 - Mapper映射文件配置"><!---->MyBatis详解 - Mapper映射文件配置<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/dependencies/mybatis/mybatis-y-sql-exec.html" class="nav-link sidebar-link sidebar-page" aria-label="MyBatis详解 - sqlSession执行流程"><!---->MyBatis详解 - sqlSession执行流程<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/dependencies/mybatis/mybatis-y-dynamic-sql.html" class="nav-link sidebar-link sidebar-page" aria-label="MyBatis详解 - 动态SQL使用与原理"><!---->MyBatis详解 - 动态SQL使用与原理<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/dependencies/mybatis/mybatis-y-plugin.html" class="nav-link sidebar-link sidebar-page" aria-label="MyBatis详解 - 插件机制"><!---->MyBatis详解 - 插件机制<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/dependencies/mybatis/mybatis-y-plugin-page.html" class="nav-link sidebar-link sidebar-page" aria-label="MyBatis详解 - 插件之分页机制"><!---->MyBatis详解 - 插件之分页机制<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a aria-current="page" href="/dependencies/mybatis/mybatis-y-datasource.html" class="router-link-active router-link-exact-active nav-link active sidebar-link sidebar-page active" aria-label="MyBatis详解 - 数据源与连接池"><!---->MyBatis详解 - 数据源与连接池<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/dependencies/mybatis/mybatis-y-datasource.html#_1-mybatis数据源datasource分类" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="1. MyBatis数据源DataSource分类"><!---->1. MyBatis数据源DataSource分类<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/dependencies/mybatis/mybatis-y-datasource.html#_2-官网datasource配置内容清单" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="2. 官网DataSource配置内容清单"><!---->2. 官网DataSource配置内容清单<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/dependencies/mybatis/mybatis-y-datasource.html#_2-1-unpooled" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="2.1 UNPOOLED"><!---->2.1 UNPOOLED<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/dependencies/mybatis/mybatis-y-datasource.html#_2-2-pooled" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="2.2 POOLED"><!---->2.2 POOLED<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/dependencies/mybatis/mybatis-y-datasource.html#_2-3-jndi" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="2.3 JNDI"><!---->2.3 JNDI<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/dependencies/mybatis/mybatis-y-datasource.html#_3-数据源datasource的创建过程" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="3. 数据源DataSource的创建过程"><!---->3. 数据源DataSource的创建过程<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/dependencies/mybatis/mybatis-y-datasource.html#_4-datasource什么时候创建connection对象" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="4. DataSource什么时候创建Connection对象"><!---->4. DataSource什么时候创建Connection对象<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/dependencies/mybatis/mybatis-y-datasource.html#_5-不使用连接池的unpooleddatasource" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="5. 不使用连接池的UnpooledDataSource"><!---->5. 不使用连接池的UnpooledDataSource<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/dependencies/mybatis/mybatis-y-datasource.html#_6-为什么要使用连接池" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="6. 为什么要使用连接池"><!---->6. 为什么要使用连接池<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/dependencies/mybatis/mybatis-y-datasource.html#_7-使用了连接池的pooleddatasource" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="7. 使用了连接池的PooledDataSource"><!---->7. 使用了连接池的PooledDataSource<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/dependencies/mybatis/mybatis-y-datasource.html#_8-jndi类型的数据源datasource" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="8. JNDI类型的数据源DataSource"><!---->8. JNDI类型的数据源DataSource<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/dependencies/mybatis/mybatis-y-datasource.html#参考文章" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="参考文章"><!---->参考文章<!----></a><ul class="sidebar-sub-headers"></ul></li></ul><!--]--></li><li><!--[--><a href="/dependencies/mybatis/mybatis-y-trans.html" class="nav-link sidebar-link sidebar-page" aria-label="MyBatis详解 - 事务管理机制"><!---->MyBatis详解 - 事务管理机制<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/dependencies/mybatis/mybatis-y-cache-level1.html" class="nav-link sidebar-link sidebar-page" aria-label="MyBatis详解 - 一级缓存实现机制"><!---->MyBatis详解 - 一级缓存实现机制<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/dependencies/mybatis/mybatis-y-cache-level2.html" class="nav-link sidebar-link sidebar-page" aria-label="MyBatis详解 - 二级缓存实现机制"><!---->MyBatis详解 - 二级缓存实现机制<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/dependencies/mybatis/mybatis-z-injection.html" class="nav-link sidebar-link sidebar-page" aria-label="MyBatis问题 - Mybatis是如何防止SQL注入的"><!---->MyBatis问题 - Mybatis是如何防止SQL注入的<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/dependencies/mybatis/mybatis-i-pagehelper.html" class="nav-link sidebar-link sidebar-page" aria-label="MyBatis PageHelper分页"><!---->MyBatis PageHelper分页<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/dependencies/mybatis/mybatis-z-pageHelper-source.html" class="nav-link sidebar-link sidebar-page" aria-label="Mybatis-PageHelper源码分析"><!---->Mybatis-PageHelper源码分析<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/dependencies/mybatis/mybatis-z-one-more-temp.html" class="nav-link sidebar-link sidebar-page" aria-label="Mybatis一对多关联查询（级联查询）Mapper模板"><!---->Mybatis一对多关联查询（级联查询）Mapper模板<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/dependencies/mybatis/mybatis-z-if-number.html" class="nav-link sidebar-link sidebar-page" aria-label="mybatis中if关于数字的判断"><!---->mybatis中if关于数字的判断<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/dependencies/mybatis/mybatis-z-one-more-join.html" class="nav-link sidebar-link sidebar-page" aria-label="Mybatis使用collection解决一对多关联查询"><!---->Mybatis使用collection解决一对多关联查询<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/dependencies/mybatis/mybatis-z-base-opera.html" class="nav-link sidebar-link sidebar-page" aria-label="Mybatis基础操作Mapper模板"><!---->Mybatis基础操作Mapper模板<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/dependencies/mybatis/mybatis-i-overview.html" class="nav-link sidebar-link sidebar-page" aria-label="Mybatis概念"><!---->Mybatis概念<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/dependencies/mybatis/mybatis-i-anotation.html" class="nav-link sidebar-link sidebar-page" aria-label="MyBatis注解方式"><!---->MyBatis注解方式<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/dependencies/mybatis/mybatis-z-batch-opera.html" class="nav-link sidebar-link sidebar-page" aria-label="Mybatis进阶操作Mapper模板"><!---->Mybatis进阶操作Mapper模板<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/dependencies/mybatis/mybatis-z-adapter-db.html" class="nav-link sidebar-link sidebar-page" aria-label="Mybatis适配多种数据库"><!---->Mybatis适配多种数据库<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li></ul></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><!----><span class="title">ORM-Mybatis-Plus</span><span class="arrow right"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><!----><span class="title">数据库管理-Sharding-JDBC</span><span class="arrow right"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><!----><span class="title">ORM-hibernate</span><span class="arrow right"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><!----><span class="title">数据库连接池</span><span class="arrow right"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><!----><span class="title">ORM-JPA</span><span class="arrow right"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><!----><span class="title">CAS单点登录</span><span class="arrow right"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><!----><span class="title">数据库管理-Flyway</span><span class="arrow right"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><!----><span class="title">定时任务</span><span class="arrow right"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><!----><span class="title">Api文档</span><span class="arrow right"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><!----><span class="title">Office文档操作</span><span class="arrow right"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><!----><span class="title">二维码识别</span><span class="arrow right"></span></button><!----></section></li></ul><!--[--><!----><!--]--></aside><!--[--><main class="page" id="main-content"><!--[--><!----><nav class="breadcrumb disable"></nav><div class="page-title"><h1><!---->MyBatis详解 - 数据源与连接池</h1><div class="page-info"><span class="author-info" aria-label="作者🖊" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon author-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="author icon"><path d="M649.6 633.6c86.4-48 147.2-144 147.2-249.6 0-160-128-288-288-288s-288 128-288 288c0 108.8 57.6 201.6 147.2 249.6-121.6 48-214.4 153.6-240 288-3.2 9.6 0 19.2 6.4 25.6 3.2 9.6 12.8 12.8 22.4 12.8h704c9.6 0 19.2-3.2 25.6-12.8 6.4-6.4 9.6-16 6.4-25.6-25.6-134.4-121.6-240-243.2-288z"></path></svg><span><a class="author-item" href="https://java.isture.com" target="_blank" rel="noopener noreferrer">zszdevelop</a></span><span property="author" content="zszdevelop"></span></span><!----><span class="date-info" aria-label="写作日期📅" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon calendar-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="calendar icon"><path d="M716.4 110.137c0-18.753-14.72-33.473-33.472-33.473-18.753 0-33.473 14.72-33.473 33.473v33.473h66.993v-33.473zm-334.87 0c0-18.753-14.72-33.473-33.473-33.473s-33.52 14.72-33.52 33.473v33.473h66.993v-33.473zm468.81 33.52H716.4v100.465c0 18.753-14.72 33.473-33.472 33.473a33.145 33.145 0 01-33.473-33.473V143.657H381.53v100.465c0 18.753-14.72 33.473-33.473 33.473a33.145 33.145 0 01-33.473-33.473V143.657H180.6A134.314 134.314 0 0046.66 277.595v535.756A134.314 134.314 0 00180.6 947.289h669.74a134.36 134.36 0 00133.94-133.938V277.595a134.314 134.314 0 00-133.94-133.938zm33.473 267.877H147.126a33.145 33.145 0 01-33.473-33.473c0-18.752 14.72-33.473 33.473-33.473h736.687c18.752 0 33.472 14.72 33.472 33.473a33.145 33.145 0 01-33.472 33.473z"></path></svg><span><!----></span><meta property="datePublished" content="2023-02-20T13:42:31.000Z"></span><span class="category-info" aria-label="分类🌈" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon category-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="category icon"><path d="M148.41 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H148.41c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.311-40.31zM147.556 553.478H429.73c22.263 0 40.311 18.048 40.311 40.31v282.176c0 22.263-18.048 40.312-40.31 40.312H147.555c-22.263 0-40.311-18.049-40.311-40.312V593.79c0-22.263 18.048-40.311 40.31-40.311zM593.927 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H593.927c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.31-40.31zM730.22 920.502H623.926c-40.925 0-74.22-33.388-74.22-74.425V623.992c0-41.038 33.387-74.424 74.425-74.424h222.085c41.038 0 74.424 33.226 74.424 74.067v114.233c0 10.244-8.304 18.548-18.547 18.548s-18.548-8.304-18.548-18.548V623.635c0-20.388-16.746-36.974-37.33-36.974H624.13c-20.585 0-37.331 16.747-37.331 37.33v222.086c0 20.585 16.654 37.331 37.126 37.331H730.22c10.243 0 18.547 8.304 18.547 18.547 0 10.244-8.304 18.547-18.547 18.547z"></path></svg><span class="category-item category2" role>MyBatis</span><meta property="articleSection" content="MyBatis"></span><!----><span class="reading-time-info" aria-label="阅读时间⌛" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon timer-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="timer icon"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z"></path></svg><span>大约 17 分钟</span><meta property="timeRequired" content="PT17M"></span></div><hr></div><div class="toc-place-holder"><aside id="toc"><div class="toc-header">此页内容</div><div class="toc-wrapper"><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/dependencies/mybatis/mybatis-y-datasource.html#_1-mybatis数据源datasource分类" class="router-link-active router-link-exact-active toc-link level2">1. MyBatis数据源DataSource分类</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/dependencies/mybatis/mybatis-y-datasource.html#_2-官网datasource配置内容清单" class="router-link-active router-link-exact-active toc-link level2">2. 官网DataSource配置内容清单</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/dependencies/mybatis/mybatis-y-datasource.html#_2-1-unpooled" class="router-link-active router-link-exact-active toc-link level3">2.1 UNPOOLED</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/dependencies/mybatis/mybatis-y-datasource.html#_2-2-pooled" class="router-link-active router-link-exact-active toc-link level3">2.2 POOLED</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/dependencies/mybatis/mybatis-y-datasource.html#_2-3-jndi" class="router-link-active router-link-exact-active toc-link level3">2.3 JNDI</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/dependencies/mybatis/mybatis-y-datasource.html#_3-数据源datasource的创建过程" class="router-link-active router-link-exact-active toc-link level2">3. 数据源DataSource的创建过程</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/dependencies/mybatis/mybatis-y-datasource.html#_4-datasource什么时候创建connection对象" class="router-link-active router-link-exact-active toc-link level2">4. DataSource什么时候创建Connection对象</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/dependencies/mybatis/mybatis-y-datasource.html#_5-不使用连接池的unpooleddatasource" class="router-link-active router-link-exact-active toc-link level2">5. 不使用连接池的UnpooledDataSource</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/dependencies/mybatis/mybatis-y-datasource.html#_6-为什么要使用连接池" class="router-link-active router-link-exact-active toc-link level2">6. 为什么要使用连接池</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/dependencies/mybatis/mybatis-y-datasource.html#_7-使用了连接池的pooleddatasource" class="router-link-active router-link-exact-active toc-link level2">7. 使用了连接池的PooledDataSource</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/dependencies/mybatis/mybatis-y-datasource.html#_8-jndi类型的数据源datasource" class="router-link-active router-link-exact-active toc-link level2">8. JNDI类型的数据源DataSource</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/dependencies/mybatis/mybatis-y-datasource.html#参考文章" class="router-link-active router-link-exact-active toc-link level2">参考文章</a></li><!----><!--]--></ul></div></aside></div><!----><div class="theme-hope-content"><h1 id="mybatis详解-数据源与连接池" tabindex="-1"><a class="header-anchor" href="#mybatis详解-数据源与连接池" aria-hidden="true">#</a> MyBatis详解 - 数据源与连接池</h1><blockquote><p>本文主要介绍MyBatis数据源和连接池相关的内容。</p></blockquote><h2 id="_1-mybatis数据源datasource分类" tabindex="-1"><a class="header-anchor" href="#_1-mybatis数据源datasource分类" aria-hidden="true">#</a> 1. MyBatis数据源DataSource分类</h2><p>MyBatis把数据源DataSource分为三种：</p><ul><li>UNPOOLED 不使用连接池的数据源</li><li>POOLED 使用连接池的数据源</li><li>JNDI 使用JNDI实现的数据源</li></ul><p>相应地，MyBatis内部分别定义了实现了java.sql.DataSource接口的UnpooledDataSource，PooledDataSource类来表示UNPOOLED、POOLED类型的数据源。</p><figure><img src="https://zszblog.oss-cn-beijing.aliyuncs.com/zszblog/image-20220730202017360.png" alt="image-20220730202017360" tabindex="0" loading="lazy"><figcaption>image-20220730202017360</figcaption></figure><p>对于JNDI类型的数据源DataSource，则是通过JNDI上下文中取值。</p><h2 id="_2-官网datasource配置内容清单" tabindex="-1"><a class="header-anchor" href="#_2-官网datasource配置内容清单" aria-hidden="true">#</a> 2. 官网DataSource配置内容清单</h2><p>dataSource 元素使用标准的 JDBC 数据源接口来配置 JDBC 连接对象的资源。</p><p>大多数 MyBatis 应用程序会按示例中的例子来配置数据源。虽然数据源配置是可选的，但如果要启用延迟加载特性，就必须配置数据源。 有三种内建的数据源类型（也就是 <code>type=&quot;[UNPOOLED|POOLED|JNDI]&quot;</code>）：</p><h3 id="_2-1-unpooled" tabindex="-1"><a class="header-anchor" href="#_2-1-unpooled" aria-hidden="true">#</a> 2.1 UNPOOLED</h3><p>这个数据源的实现会每次请求时打开和关闭连接。虽然有点慢，但对那些数据库连接可用性要求不高的简单应用程序来说，是一个很好的选择。 性能表现则依赖于使用的数据库，对某些数据库来说，使用连接池并不重要，这个配置就很适合这种情形。UNPOOLED 类型的数据源仅仅需要配置以下 5 种属性：</p><ul><li>driver – 这是 JDBC 驱动的 Java 类全限定名（并不是 JDBC 驱动中可能包含的数据源类）。</li><li>url – 这是数据库的 JDBC URL 地址。</li><li>username – 登录数据库的用户名。</li><li>password – 登录数据库的密码。</li><li>defaultTransactionIsolationLevel – 默认的连接事务隔离级别。</li><li>defaultNetworkTimeout – 等待数据库操作完成的默认网络超时时间（单位：毫秒）。查看 java.sql.Connection#setNetworkTimeout() 的 API 文档以获取更多信息。</li></ul><p>作为可选项，你也可以传递属性给数据库驱动。只需在属性名加上“driver.”前缀即可，例如：</p><ul><li>driver.encoding=UTF8</li></ul><p>这将通过 DriverManager.getConnection(url, driverProperties) 方法传递值为 UTF8 的 encoding 属性给数据库驱动。</p><h3 id="_2-2-pooled" tabindex="-1"><a class="header-anchor" href="#_2-2-pooled" aria-hidden="true">#</a> 2.2 POOLED</h3><p>这种数据源的实现利用“池”的概念将 JDBC 连接对象组织起来，避免了创建新的连接实例时所必需的初始化和认证时间。 这种处理方式很流行，能使并发 Web 应用快速响应请求。</p><p>除了上述提到 UNPOOLED 下的属性外，还有更多属性用来配置 POOLED 的数据源：</p><ul><li>poolMaximumActiveConnections – 在任意时间可存在的活动（正在使用）连接数量，默认值：10</li><li>poolMaximumIdleConnections – 任意时间可能存在的空闲连接数。</li><li>poolMaximumCheckoutTime – 在被强制返回之前，池中连接被检出（checked out）时间，默认值：20000 毫秒（即 20 秒）</li><li>poolTimeToWait – 这是一个底层设置，如果获取连接花费了相当长的时间，连接池会打印状态日志并重新尝试获取一个连接（避免在误配置的情况下一直失败且不打印日志），默认值：20000 毫秒（即 20 秒）。</li><li>poolMaximumLocalBadConnectionTolerance – 这是一个关于坏连接容忍度的底层设置， 作用于每一个尝试从缓存池获取连接的线程。 如果这个线程获取到的是一个坏的连接，那么这个数据源允许这个线程尝试重新获取一个新的连接，但是这个重新尝试的次数不应该超过 poolMaximumIdleConnections 与 poolMaximumLocalBadConnectionTolerance 之和。 默认值：3（新增于 3.4.5）</li><li>poolPingQuery – 发送到数据库的侦测查询，用来检验连接是否正常工作并准备接受请求。默认是“NO PING QUERY SET”，这会导致多数数据库驱动出错时返回恰当的错误消息。</li><li>poolPingEnabled – 是否启用侦测查询。若开启，需要设置 poolPingQuery 属性为一个可执行的 SQL 语句（最好是一个速度非常快的 SQL 语句），默认值：false。</li><li>poolPingConnectionsNotUsedFor – 配置 poolPingQuery 的频率。可以被设置为和数据库连接超时时间一样，来避免不必要的侦测，默认值：0（即所有连接每一时刻都被侦测 — 当然仅当 poolPingEnabled 为 true 时适用）。</li></ul><h3 id="_2-3-jndi" tabindex="-1"><a class="header-anchor" href="#_2-3-jndi" aria-hidden="true">#</a> 2.3 JNDI</h3><p>这个数据源实现是为了能在如 EJB 或应用服务器这类容器中使用，容器可以集中或在外部配置数据源，然后放置一个 JNDI 上下文的数据源引用。这种数据源配置只需要两个属性：</p><ul><li>initial_context – 这个属性用来在 InitialContext 中寻找上下文（即，initialContext.lookup(initial_context)）。这是个可选属性，如果忽略，那么将会直接从 InitialContext 中寻找 data_source 属性。</li><li>data_source – 这是引用数据源实例位置的上下文路径。提供了 initial_context 配置时会在其返回的上下文中进行查找，没有提供时则直接在 InitialContext 中查找。</li></ul><p>和其他数据源配置类似，可以通过添加前缀“env.”直接把属性传递给 InitialContext。比如：</p><ul><li>env.encoding=UTF8</li></ul><p>这就会在 InitialContext 实例化时往它的构造方法传递值为 UTF8 的 encoding 属性。</p><p>你可以通过实现接口 org.apache.ibatis.datasource.DataSourceFactory 来使用第三方数据源实现：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">DataSourceFactory</span> <span class="token punctuation">{</span>
  <span class="token keyword">void</span> <span class="token function">setProperties</span><span class="token punctuation">(</span><span class="token class-name">Properties</span> props<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">DataSource</span> <span class="token function">getDataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>org.apache.ibatis.datasource.unpooled.UnpooledDataSourceFactory 可被用作父类来构建新的数据源适配器，比如下面这段插入 C3P0 数据源所必需的代码：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>ibatis<span class="token punctuation">.</span>datasource<span class="token punctuation">.</span>unpooled<span class="token punctuation">.</span></span><span class="token class-name">UnpooledDataSourceFactory</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>mchange<span class="token punctuation">.</span>v2<span class="token punctuation">.</span>c3p0<span class="token punctuation">.</span></span><span class="token class-name">ComboPooledDataSource</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">C3P0DataSourceFactory</span> <span class="token keyword">extends</span> <span class="token class-name">UnpooledDataSourceFactory</span> <span class="token punctuation">{</span>

  <span class="token keyword">public</span> <span class="token class-name">C3P0DataSourceFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>dataSource <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ComboPooledDataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>为了令其工作，记得在配置文件中为每个希望 MyBatis 调用的 setter 方法增加对应的属性。 下面是一个可以连接至 PostgreSQL 数据库的例子：</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dataSource</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>org.myproject.C3P0DataSourceFactory<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>driver<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>org.postgresql.Driver<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>url<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>jdbc:postgresql:mydb<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>username<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>postgres<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>password<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>root<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dataSource</span><span class="token punctuation">&gt;</span></span>  
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_3-数据源datasource的创建过程" tabindex="-1"><a class="header-anchor" href="#_3-数据源datasource的创建过程" aria-hidden="true">#</a> 3. 数据源DataSource的创建过程</h2><p>MyBatis数据源DataSource对象的创建发生在MyBatis初始化的过程中。下面让我们一步步地了解MyBatis是如何创建数据源DataSource的。</p><p>在mybatis的XML配置文件中，使用<code>&lt;dataSource&gt;</code>元素来配置数据源：</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dataSource</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>org.myproject.C3P0DataSourceFactory<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>driver<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>org.postgresql.Driver<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>url<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>jdbc:postgresql:mydb<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>username<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>postgres<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>password<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>root<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dataSource</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>MyBatis在初始化时，解析此文件，根据<code>&lt;dataSource&gt;</code>的type属性来创建相应类型的的数据源DataSource，即：</p><ul><li>type=”POOLED” ：MyBatis会创建PooledDataSource实例</li><li>type=”UNPOOLED” ：MyBatis会创建UnpooledDataSource实例</li><li>type=”JNDI” ：MyBatis会从JNDI服务上查找DataSource实例，然后返回使用</li></ul><p>顺便说一下，MyBatis是通过工厂模式来创建数据源DataSource对象的，MyBatis定义了抽象的工厂接口:org.apache.ibatis.datasource.DataSourceFactory,通过其getDataSource()方法返回数据源DataSource：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">DataSourceFactory</span> <span class="token punctuation">{</span> 
    <span class="token keyword">void</span> <span class="token function">setProperties</span><span class="token punctuation">(</span><span class="token class-name">Properties</span> props<span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token comment">// 生产DataSource  </span>
    <span class="token class-name">DataSource</span> <span class="token function">getDataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>上述三种不同类型的type，则有对应的以下dataSource工厂：</p><ul><li>POOLED PooledDataSourceFactory</li><li>UNPOOLED UnpooledDataSourceFactory</li><li>JNDI JndiDataSourceFactory</li></ul><p>其类图如下所示：</p><figure><img src="https://zszblog.oss-cn-beijing.aliyuncs.com/zszblog/image-20220730204145183.png" alt="image-20220730204145183" tabindex="0" loading="lazy"><figcaption>image-20220730204145183</figcaption></figure><p>MyBatis创建了DataSource实例后，会将其放到Configuration对象内的Environment对象中，供以后使用。</p><h2 id="_4-datasource什么时候创建connection对象" tabindex="-1"><a class="header-anchor" href="#_4-datasource什么时候创建connection对象" aria-hidden="true">#</a> 4. DataSource什么时候创建Connection对象</h2><p>当我们需要创建SqlSession对象并需要执行SQL语句时，这时候MyBatis才会去调用dataSource对象来创建java.sql.Connection对象。也就是说，java.sql.Connection对象的创建一直延迟到执行SQL语句的时候。</p><p>比如，我们有如下方法执行一个简单的SQL语句：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">String</span> resource <span class="token operator">=</span> <span class="token string">&quot;mybatis-config.xml&quot;</span><span class="token punctuation">;</span>  
<span class="token class-name">InputStream</span> inputStream <span class="token operator">=</span> <span class="token class-name">Resources</span><span class="token punctuation">.</span><span class="token function">getResourceAsStream</span><span class="token punctuation">(</span>resource<span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token class-name">SqlSessionFactory</span> sqlSessionFactory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SqlSessionFactoryBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span>inputStream<span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token class-name">SqlSession</span> sqlSession <span class="token operator">=</span> sqlSessionFactory<span class="token punctuation">.</span><span class="token function">openSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
sqlSession<span class="token punctuation">.</span><span class="token function">selectList</span><span class="token punctuation">(</span><span class="token string">&quot;SELECT * FROM STUDENTS&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>前4句都不会导致java.sql.Connection对象的创建，只有当第5句sqlSession.selectList(&quot;SELECT * FROM STUDENTS&quot;)，才会触发MyBatis在底层执行下面这个方法来创建java.sql.Connection对象：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">openConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SQLException</span> <span class="token punctuation">{</span>  
    <span class="token keyword">if</span> <span class="token punctuation">(</span>log<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  
        log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Opening JDBC Connection&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token punctuation">}</span>  
    connection <span class="token operator">=</span> dataSource<span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token keyword">if</span> <span class="token punctuation">(</span>level <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  
        connection<span class="token punctuation">.</span><span class="token function">setTransactionIsolation</span><span class="token punctuation">(</span>level<span class="token punctuation">.</span><span class="token function">getLevel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token punctuation">}</span>  
    <span class="token function">setDesiredAutoCommit</span><span class="token punctuation">(</span>autoCommmit<span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token punctuation">}</span>  

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_5-不使用连接池的unpooleddatasource" tabindex="-1"><a class="header-anchor" href="#_5-不使用连接池的unpooleddatasource" aria-hidden="true">#</a> 5. 不使用连接池的UnpooledDataSource</h2><p>当 <code>&lt;dataSource&gt;</code>的type属性被配置成了”UNPOOLED”，MyBatis首先会实例化一个UnpooledDataSourceFactory工厂实例，然后通过.getDataSource()方法返回一个UnpooledDataSource实例对象引用，我们假定为dataSource。</p><p>使用UnpooledDataSource的getConnection(),每调用一次就会产生一个新的Connection实例对象。</p><p>UnPooledDataSource的getConnection()方法实现如下：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">/* 
 * UnpooledDataSource的getConnection()实现 
 */</span>  
<span class="token keyword">public</span> <span class="token class-name">Connection</span> <span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SQLException</span>  
<span class="token punctuation">{</span>  
    <span class="token keyword">return</span> <span class="token function">doGetConnection</span><span class="token punctuation">(</span>username<span class="token punctuation">,</span> password<span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token punctuation">}</span>  
  
<span class="token keyword">private</span> <span class="token class-name">Connection</span> <span class="token function">doGetConnection</span><span class="token punctuation">(</span><span class="token class-name">String</span> username<span class="token punctuation">,</span> <span class="token class-name">String</span> password<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SQLException</span>  
<span class="token punctuation">{</span>  
    <span class="token comment">//封装username和password成properties  </span>
    <span class="token class-name">Properties</span> props <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Properties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token keyword">if</span> <span class="token punctuation">(</span>driverProperties <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>  
    <span class="token punctuation">{</span>  
        props<span class="token punctuation">.</span><span class="token function">putAll</span><span class="token punctuation">(</span>driverProperties<span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token punctuation">}</span>  
    <span class="token keyword">if</span> <span class="token punctuation">(</span>username <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>  
    <span class="token punctuation">{</span>  
        props<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">,</span> username<span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token punctuation">}</span>  
    <span class="token keyword">if</span> <span class="token punctuation">(</span>password <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>  
    <span class="token punctuation">{</span>  
        props<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">&quot;password&quot;</span><span class="token punctuation">,</span> password<span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token punctuation">}</span>  
    <span class="token keyword">return</span> <span class="token function">doGetConnection</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token punctuation">}</span>  
  
<span class="token comment">/* 
 *  获取数据连接 
 */</span>  
<span class="token keyword">private</span> <span class="token class-name">Connection</span> <span class="token function">doGetConnection</span><span class="token punctuation">(</span><span class="token class-name">Properties</span> properties<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SQLException</span>  
<span class="token punctuation">{</span>  
    <span class="token comment">//1.初始化驱动  </span>
    <span class="token function">initializeDriver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token comment">//2.从DriverManager中获取连接，获取新的Connection对象  </span>
    <span class="token class-name">Connection</span> connection <span class="token operator">=</span> <span class="token class-name">DriverManager</span><span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> properties<span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token comment">//3.配置connection属性  </span>
    <span class="token function">configureConnection</span><span class="token punctuation">(</span>connection<span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token keyword">return</span> connection<span class="token punctuation">;</span>  
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>如上代码所示，UnpooledDataSource会做以下事情：</p><ul><li><strong>初始化驱动</strong>：判断driver驱动是否已经加载到内存中，如果还没有加载，则会动态地加载driver类，并实例化一个Driver对象，使用DriverManager.registerDriver()方法将其注册到内存中，以供后续使用。</li><li><strong>创建Connection对象</strong>：使用DriverManager.getConnection()方法创建连接。</li><li><strong>配置Connection对象</strong>：设置是否自动提交autoCommit和隔离级别isolationLevel。</li><li><strong>返回Connection对象</strong>。</li></ul><p>上述的序列图如下所示：</p><figure><img src="https://zszblog.oss-cn-beijing.aliyuncs.com/zszblog/image-20220730204543578.png" alt="image-20220730204543578" tabindex="0" loading="lazy"><figcaption>image-20220730204543578</figcaption></figure><p>总结：从上述的代码中可以看到，我们每调用一次getConnection()方法，都会通过DriverManager.getConnection()返回新的java.sql.Connection实例。</p><h2 id="_6-为什么要使用连接池" tabindex="-1"><a class="header-anchor" href="#_6-为什么要使用连接池" aria-hidden="true">#</a> 6. 为什么要使用连接池</h2><ul><li><strong>创建一个java.sql.Connection实例对象的代价</strong></li></ul><p>首先让我们来看一下创建一个java.sql.Connection对象的资源消耗。我们通过连接Oracle数据库，创建创建Connection对象，来看创建一个Connection对象、执行SQL语句各消耗多长时间。代码如下：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span>  
<span class="token punctuation">{</span>  
 
   <span class="token class-name">String</span> sql <span class="token operator">=</span> <span class="token string">&quot;select * from hr.employees where employee_id &lt; ? and employee_id &gt;= ?&quot;</span><span class="token punctuation">;</span>  
   <span class="token class-name">PreparedStatement</span> st <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>  
   <span class="token class-name">ResultSet</span> rs <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>  
 
   <span class="token keyword">long</span> beforeTimeOffset <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1L</span><span class="token punctuation">;</span> <span class="token comment">//创建Connection对象前时间  </span>
   <span class="token keyword">long</span> afterTimeOffset <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1L</span><span class="token punctuation">;</span> <span class="token comment">//创建Connection对象后时间  </span>
   <span class="token keyword">long</span> executeTimeOffset <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1L</span><span class="token punctuation">;</span> <span class="token comment">//创建Connection对象后时间  </span>
 
   <span class="token class-name">Connection</span> con <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>  
   <span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">&quot;oracle.jdbc.driver.OracleDriver&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
 
   beforeTimeOffset <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
   <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;before:\t&quot;</span> <span class="token operator">+</span> beforeTimeOffset<span class="token punctuation">)</span><span class="token punctuation">;</span>  
 
   con <span class="token operator">=</span> <span class="token class-name">DriverManager</span><span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token string">&quot;jdbc:oracle:thin:@127.0.0.1:1521:xe&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;louluan&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;123456&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
 
   afterTimeOffset <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
   <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;after:\t\t&quot;</span> <span class="token operator">+</span> afterTimeOffset<span class="token punctuation">)</span><span class="token punctuation">;</span>  
   <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Create Costs:\t\t&quot;</span> <span class="token operator">+</span> <span class="token punctuation">(</span>afterTimeOffset <span class="token operator">-</span> beforeTimeOffset<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; ms&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
 
   st <span class="token operator">=</span> con<span class="token punctuation">.</span><span class="token function">prepareStatement</span><span class="token punctuation">(</span>sql<span class="token punctuation">)</span><span class="token punctuation">;</span>  
   <span class="token comment">//设置参数  </span>
   st<span class="token punctuation">.</span><span class="token function">setInt</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">101</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
   st<span class="token punctuation">.</span><span class="token function">setInt</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
   <span class="token comment">//查询，得出结果集  </span>
   rs <span class="token operator">=</span> st<span class="token punctuation">.</span><span class="token function">executeQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
   executeTimeOffset <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
   <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Exec Costs:\t\t&quot;</span> <span class="token operator">+</span> <span class="token punctuation">(</span>executeTimeOffset <span class="token operator">-</span> afterTimeOffset<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; ms&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
 
<span class="token punctuation">}</span>  
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>上述程序的执行结果为：</p><figure><img src="https://zszblog.oss-cn-beijing.aliyuncs.com/zszblog/image-20220730204747727.png" alt="image-20220730204747727" tabindex="0" loading="lazy"><figcaption>image-20220730204747727</figcaption></figure><p>从此结果可以清楚地看出，创建一个Connection对象，用了250 毫秒；而执行SQL的时间用了170毫秒。</p><p>创建一个Connection对象用了250毫秒！这个时间对计算机来说可以说是一个非常奢侈的！</p><p>这仅仅是一个Connection对象就有这么大的代价，设想一下另外一种情况：如果我们在Web应用程序中，为用户的每一个请求就操作一次数据库，当有10000个在线用户并发操作的话，对计算机而言，仅仅创建Connection对象不包括做业务的时间就要损耗10000×250ms= 250 0000 ms = 2500 s = 41.6667 min,竟然要41分钟！！！如果对高用户群体使用这样的系统，简直就是开玩笑！</p><ul><li><strong>问题分析</strong>：</li></ul><p>创建一个java.sql.Connection对象的代价是如此巨大，是因为创建一个Connection对象的过程，在底层就相当于和数据库建立的通信连接，在建立通信连接的过程，消耗了这么多的时间，而往往我们建立连接后（即创建Connection对象后），就执行一个简单的SQL语句，然后就要抛弃掉，这是一个非常大的资源浪费！</p><ul><li><strong>解决方案</strong>：</li></ul><p>对于需要频繁地跟数据库交互的应用程序，可以在创建了Connection对象，并操作完数据库后，可以不释放掉资源，而是将它放到内存中，当下次需要操作数据库时，可以直接从内存中取出Connection对象，不需要再创建了，这样就极大地节省了创建Connection对象的资源消耗。由于内存也是有限和宝贵的，这又对我们对内存中的Connection对象怎么有效地维护提出了很高的要求。我们将在内存中存放Connection对象的容器称之为连接池（Connection Pool）。下面让我们来看一下MyBatis的线程池是怎样实现的。</p><h2 id="_7-使用了连接池的pooleddatasource" tabindex="-1"><a class="header-anchor" href="#_7-使用了连接池的pooleddatasource" aria-hidden="true">#</a> 7. 使用了连接池的PooledDataSource</h2><p>同样地，我们也是使用PooledDataSource的getConnection()方法来返回Connection对象。现在让我们看一下它的基本原理：</p><p>PooledDataSource将java.sql.Connection对象包裹成PooledConnection对象放到了PoolState类型的容器中维护。 MyBatis将连接池中的PooledConnection分为两种状态：空闲状态（idle）和活动状态(active)，这两种状态的PooledConnection对象分别被存储到PoolState容器内的idleConnections和activeConnections两个List集合中：</p><ul><li><strong>idleConnections</strong>: 空闲(idle)状态PooledConnection对象被放置到此集合中，表示当前闲置的没有被使用的PooledConnection集合，调用PooledDataSource的getConnection()方法时，会优先从此集合中取PooledConnection对象。当用完一个java.sql.Connection对象时，MyBatis会将其包裹成PooledConnection对象放到此集合中。</li><li><strong>activeConnections</strong>: 活动(active)状态的PooledConnection对象被放置到名为activeConnections的ArrayList中，表示当前正在被使用的PooledConnection集合，调用PooledDataSource的getConnection()方法时，会优先从idleConnections集合中取PooledConnection对象,如果没有，则看此集合是否已满，如果未满，PooledDataSource会创建出一个PooledConnection，添加到此集合中，并返回。</li></ul><p><strong>PoolState连接池的大致结构</strong>如下所示：</p><figure><img src="https://zszblog.oss-cn-beijing.aliyuncs.com/zszblog/image-20220730205444847.png" alt="image-20220730205444847" tabindex="0" loading="lazy"><figcaption>image-20220730205444847</figcaption></figure><ul><li><strong>获取java.sql.Connection对象的过程</strong></li></ul><p>下面让我们看一下PooledDataSource 的getConnection()方法获取Connection对象的实现：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">Connection</span> <span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SQLException</span> <span class="token punctuation">{</span>  
    <span class="token keyword">return</span> <span class="token function">popConnection</span><span class="token punctuation">(</span>dataSource<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dataSource<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getProxyConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token punctuation">}</span>  
 
<span class="token keyword">public</span> <span class="token class-name">Connection</span> <span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token class-name">String</span> username<span class="token punctuation">,</span> <span class="token class-name">String</span> password<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SQLException</span> <span class="token punctuation">{</span>  
    <span class="token keyword">return</span> <span class="token function">popConnection</span><span class="token punctuation">(</span>username<span class="token punctuation">,</span> password<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getProxyConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>上述的popConnection()方法，会从连接池中返回一个可用的PooledConnection对象，然后再调用getProxyConnection()方法最终返回Conection对象。（至于为什么会有getProxyConnection(),请关注下一节）。</p><p>现在让我们看一下popConnection()方法到底做了什么：</p><ul><li>先看是否有空闲(idle)状态下的PooledConnection对象，如果有，就直接返回一个可用的PooledConnection对象；否则进行第2步。</li><li>查看活动状态的PooledConnection池activeConnections是否已满；如果没有满，则创建一个新的PooledConnection对象，然后放到activeConnections池中，然后返回此PooledConnection对象；否则进行第三步；</li><li>看最先进入activeConnections池中的PooledConnection对象是否已经过期：如果已经过期，从activeConnections池中移除此对象，然后创建一个新的PooledConnection对象，添加到activeConnections中，然后将此对象返回；否则进行第4步。</li><li>线程等待，循环2步</li></ul><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">/* 
 * 传递一个用户名和密码，从连接池中返回可用的PooledConnection 
 */</span>  
<span class="token keyword">private</span> <span class="token class-name">PooledConnection</span> <span class="token function">popConnection</span><span class="token punctuation">(</span><span class="token class-name">String</span> username<span class="token punctuation">,</span> <span class="token class-name">String</span> password<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SQLException</span>  
<span class="token punctuation">{</span>  
   <span class="token keyword">boolean</span> countedWait <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>  
   <span class="token class-name">PooledConnection</span> conn <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>  
   <span class="token keyword">long</span> t <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
   <span class="token keyword">int</span> localBadConnectionCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  
 
   <span class="token keyword">while</span> <span class="token punctuation">(</span>conn <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>  
   <span class="token punctuation">{</span>  
       <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>state<span class="token punctuation">)</span>  
       <span class="token punctuation">{</span>  
           <span class="token keyword">if</span> <span class="token punctuation">(</span>state<span class="token punctuation">.</span>idleConnections<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>  
           <span class="token punctuation">{</span>  
               <span class="token comment">// 连接池中有空闲连接，取出第一个  </span>
               conn <span class="token operator">=</span> state<span class="token punctuation">.</span>idleConnections<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
               <span class="token keyword">if</span> <span class="token punctuation">(</span>log<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  
               <span class="token punctuation">{</span>  
                   log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Checked out connection &quot;</span> <span class="token operator">+</span> conn<span class="token punctuation">.</span><span class="token function">getRealHashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; from pool.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
               <span class="token punctuation">}</span>  
           <span class="token punctuation">}</span>  
           <span class="token keyword">else</span>  
           <span class="token punctuation">{</span>  
               <span class="token comment">// 连接池中没有空闲连接，则取当前正在使用的连接数小于最大限定值，  </span>
               <span class="token keyword">if</span> <span class="token punctuation">(</span>state<span class="token punctuation">.</span>activeConnections<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> poolMaximumActiveConnections<span class="token punctuation">)</span>  
               <span class="token punctuation">{</span>  
                   <span class="token comment">// 创建一个新的connection对象  </span>
                   conn <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PooledConnection</span><span class="token punctuation">(</span>dataSource<span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
                   <span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">&quot;unused&quot;</span><span class="token punctuation">)</span>  
                   <span class="token comment">//used in logging, if enabled  </span>
                   <span class="token class-name">Connection</span> realConn <span class="token operator">=</span> conn<span class="token punctuation">.</span><span class="token function">getRealConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
                   <span class="token keyword">if</span> <span class="token punctuation">(</span>log<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  
                   <span class="token punctuation">{</span>  
                       log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Created connection &quot;</span> <span class="token operator">+</span> conn<span class="token punctuation">.</span><span class="token function">getRealHashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
                   <span class="token punctuation">}</span>  
               <span class="token punctuation">}</span>  
               <span class="token keyword">else</span>  
               <span class="token punctuation">{</span>  
                   <span class="token comment">// Cannot create new connection 当活动连接池已满，不能创建时，取出活动连接池的第一个，即最先进入连接池的PooledConnection对象  </span>
                   <span class="token comment">// 计算它的校验时间，如果校验时间大于连接池规定的最大校验时间，则认为它已经过期了，利用这个PoolConnection内部的realConnection重新生成一个PooledConnection  </span>
                   <span class="token comment">//  </span>
                   <span class="token class-name">PooledConnection</span> oldestActiveConnection <span class="token operator">=</span> state<span class="token punctuation">.</span>activeConnections<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
                   <span class="token keyword">long</span> longestCheckoutTime <span class="token operator">=</span> oldestActiveConnection<span class="token punctuation">.</span><span class="token function">getCheckoutTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
                   <span class="token keyword">if</span> <span class="token punctuation">(</span>longestCheckoutTime <span class="token operator">&gt;</span> poolMaximumCheckoutTime<span class="token punctuation">)</span>  
                   <span class="token punctuation">{</span>  
                       <span class="token comment">// Can claim overdue connection  </span>
                       state<span class="token punctuation">.</span>claimedOverdueConnectionCount<span class="token operator">++</span><span class="token punctuation">;</span>  
                       state<span class="token punctuation">.</span>accumulatedCheckoutTimeOfOverdueConnections <span class="token operator">+=</span> longestCheckoutTime<span class="token punctuation">;</span>  
                       state<span class="token punctuation">.</span>accumulatedCheckoutTime <span class="token operator">+=</span> longestCheckoutTime<span class="token punctuation">;</span>  
                       state<span class="token punctuation">.</span>activeConnections<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>oldestActiveConnection<span class="token punctuation">)</span><span class="token punctuation">;</span>  
                       <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>oldestActiveConnection<span class="token punctuation">.</span><span class="token function">getRealConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAutoCommit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  
                       <span class="token punctuation">{</span>  
                           oldestActiveConnection<span class="token punctuation">.</span><span class="token function">getRealConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">rollback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
                       <span class="token punctuation">}</span>  
                       conn <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PooledConnection</span><span class="token punctuation">(</span>oldestActiveConnection<span class="token punctuation">.</span><span class="token function">getRealConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
                       oldestActiveConnection<span class="token punctuation">.</span><span class="token function">invalidate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
                       <span class="token keyword">if</span> <span class="token punctuation">(</span>log<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  
                       <span class="token punctuation">{</span>  
                           log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Claimed overdue connection &quot;</span> <span class="token operator">+</span> conn<span class="token punctuation">.</span><span class="token function">getRealHashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
                       <span class="token punctuation">}</span>  
                   <span class="token punctuation">}</span>  
                   <span class="token keyword">else</span>  
                   <span class="token punctuation">{</span>  
 
                       <span class="token comment">//如果不能释放，则必须等待有  </span>
                       <span class="token comment">// Must wait  </span>
                       <span class="token keyword">try</span>  
                       <span class="token punctuation">{</span>  
                           <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>countedWait<span class="token punctuation">)</span>  
                           <span class="token punctuation">{</span>  
                               state<span class="token punctuation">.</span>hadToWaitCount<span class="token operator">++</span><span class="token punctuation">;</span>  
                               countedWait <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>  
                           <span class="token punctuation">}</span>  
                           <span class="token keyword">if</span> <span class="token punctuation">(</span>log<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  
                           <span class="token punctuation">{</span>  
                               log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Waiting as long as &quot;</span> <span class="token operator">+</span> poolTimeToWait <span class="token operator">+</span> <span class="token string">&quot; milliseconds for connection.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
                           <span class="token punctuation">}</span>  
                           <span class="token keyword">long</span> wt <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
                           state<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span>poolTimeToWait<span class="token punctuation">)</span><span class="token punctuation">;</span>  
                           state<span class="token punctuation">.</span>accumulatedWaitTime <span class="token operator">+=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> wt<span class="token punctuation">;</span>  
                       <span class="token punctuation">}</span>  
                       <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span>  
                       <span class="token punctuation">{</span>  
                           <span class="token keyword">break</span><span class="token punctuation">;</span>  
                       <span class="token punctuation">}</span>  
                   <span class="token punctuation">}</span>  
               <span class="token punctuation">}</span>  
           <span class="token punctuation">}</span>  
 
           <span class="token comment">//如果获取PooledConnection成功，则更新其信息  </span>
 
           <span class="token keyword">if</span> <span class="token punctuation">(</span>conn <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>  
           <span class="token punctuation">{</span>  
               <span class="token keyword">if</span> <span class="token punctuation">(</span>conn<span class="token punctuation">.</span><span class="token function">isValid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  
               <span class="token punctuation">{</span>  
                   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>conn<span class="token punctuation">.</span><span class="token function">getRealConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAutoCommit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  
                   <span class="token punctuation">{</span>  
                       conn<span class="token punctuation">.</span><span class="token function">getRealConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">rollback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
                   <span class="token punctuation">}</span>  
                   conn<span class="token punctuation">.</span><span class="token function">setConnectionTypeCode</span><span class="token punctuation">(</span><span class="token function">assembleConnectionTypeCode</span><span class="token punctuation">(</span>dataSource<span class="token punctuation">.</span><span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> username<span class="token punctuation">,</span> password<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
                   conn<span class="token punctuation">.</span><span class="token function">setCheckoutTimestamp</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
                   conn<span class="token punctuation">.</span><span class="token function">setLastUsedTimestamp</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
                   state<span class="token punctuation">.</span>activeConnections<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>conn<span class="token punctuation">)</span><span class="token punctuation">;</span>  
                   state<span class="token punctuation">.</span>requestCount<span class="token operator">++</span><span class="token punctuation">;</span>  
                   state<span class="token punctuation">.</span>accumulatedRequestTime <span class="token operator">+=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> t<span class="token punctuation">;</span>  
               <span class="token punctuation">}</span>  
               <span class="token keyword">else</span>  
               <span class="token punctuation">{</span>  
                   <span class="token keyword">if</span> <span class="token punctuation">(</span>log<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  
                   <span class="token punctuation">{</span>  
                       log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;A bad connection (&quot;</span> <span class="token operator">+</span> conn<span class="token punctuation">.</span><span class="token function">getRealHashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;) was returned from the pool, getting another connection.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
                   <span class="token punctuation">}</span>  
                   state<span class="token punctuation">.</span>badConnectionCount<span class="token operator">++</span><span class="token punctuation">;</span>  
                   localBadConnectionCount<span class="token operator">++</span><span class="token punctuation">;</span>  
                   conn <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>  
                   <span class="token keyword">if</span> <span class="token punctuation">(</span>localBadConnectionCount <span class="token operator">&gt;</span> <span class="token punctuation">(</span>poolMaximumIdleConnections <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  
                   <span class="token punctuation">{</span>  
                       <span class="token keyword">if</span> <span class="token punctuation">(</span>log<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  
                       <span class="token punctuation">{</span>  
                           log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;PooledDataSource: Could not get a good connection to the database.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
                       <span class="token punctuation">}</span>  
                       <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">SQLException</span><span class="token punctuation">(</span><span class="token string">&quot;PooledDataSource: Could not get a good connection to the database.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
                   <span class="token punctuation">}</span>  
               <span class="token punctuation">}</span>  
           <span class="token punctuation">}</span>  
       <span class="token punctuation">}</span>  
 
   <span class="token punctuation">}</span>  
 
   <span class="token keyword">if</span> <span class="token punctuation">(</span>conn <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>  
   <span class="token punctuation">{</span>  
       <span class="token keyword">if</span> <span class="token punctuation">(</span>log<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  
       <span class="token punctuation">{</span>  
           log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;PooledDataSource: Unknown severe error condition.  The connection pool returned a null connection.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
       <span class="token punctuation">}</span>  
       <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">SQLException</span><span class="token punctuation">(</span><span class="token string">&quot;PooledDataSource: Unknown severe error condition.  The connection pool returned a null connection.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
   <span class="token punctuation">}</span>  
 
   <span class="token keyword">return</span> conn<span class="token punctuation">;</span>  
<span class="token punctuation">}</span> 
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>对应的处理流程图如下所示：</p><figure><img src="https://zszblog.oss-cn-beijing.aliyuncs.com/zszblog/image-20220730212129374.png" alt="image-20220730212129374" tabindex="0" loading="lazy"><figcaption>image-20220730212129374</figcaption></figure><p>如上所示,对于PooledDataSource的getConnection()方法内，先是调用类PooledDataSource的popConnection()方法返回了一个PooledConnection对象，然后调用了PooledConnection的getProxyConnection()来返回Connection对象。</p><ul><li><strong>java.sql.Connection对象的回收</strong></li></ul><p>当我们的程序中使用完Connection对象时，如果不使用数据库连接池，我们一般会调用 connection.close()方法，关闭connection连接，释放资源。如下所示：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ClassNotFoundException</span><span class="token punctuation">,</span> <span class="token class-name">SQLException</span>  
<span class="token punctuation">{</span>  
   <span class="token class-name">String</span> sql <span class="token operator">=</span> <span class="token string">&quot;select * from hr.employees where employee_id &lt; ? and employee_id &gt;= ?&quot;</span><span class="token punctuation">;</span>  
   <span class="token class-name">PreparedStatement</span> st <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>  
   <span class="token class-name">ResultSet</span> rs <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>  
 
   <span class="token class-name">Connection</span> con <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>  
   <span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">&quot;oracle.jdbc.driver.OracleDriver&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
   <span class="token keyword">try</span>  
   <span class="token punctuation">{</span>  
       con <span class="token operator">=</span> <span class="token class-name">DriverManager</span><span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token string">&quot;jdbc:oracle:thin:@127.0.0.1:1521:xe&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;louluan&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;123456&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
       st <span class="token operator">=</span> con<span class="token punctuation">.</span><span class="token function">prepareStatement</span><span class="token punctuation">(</span>sql<span class="token punctuation">)</span><span class="token punctuation">;</span>  
       <span class="token comment">//设置参数  </span>
       st<span class="token punctuation">.</span><span class="token function">setInt</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">101</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
       st<span class="token punctuation">.</span><span class="token function">setInt</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
       <span class="token comment">//查询，得出结果集  </span>
       rs <span class="token operator">=</span> st<span class="token punctuation">.</span><span class="token function">executeQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
       <span class="token comment">//取数据，省略  </span>
       <span class="token comment">//关闭，释放资源  </span>
       con<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
   <span class="token punctuation">}</span>  
   <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">SQLException</span> e<span class="token punctuation">)</span>  
   <span class="token punctuation">{</span>  
       con<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
       e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
   <span class="token punctuation">}</span>  
<span class="token punctuation">}</span>  
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>调用过close()方法的Connection对象所持有的资源会被全部释放掉，Connection对象也就不能再使用。</p><p><strong>那么，如果我们使用了连接池，我们在用完了Connection对象时，需要将它放在连接池中，该怎样做呢</strong>？</p><p>为了和一般的使用Conneciton对象的方式保持一致，我们希望当Connection使用完后，调用.close()方法，而实际上Connection资源并没有被释放，而实际上被添加到了连接池中。这样可以做到吗？答案是可以。上述的要求从另外一个角度来描述就是：能否提供一种机制，让我们知道Connection对象调用了什么方法，从而根据不同的方法自定义相应的处理机制。恰好代理机制就可以完成上述要求.</p><p><strong>怎样实现Connection对象调用了close()方法，而实际是将其添加到连接池中</strong>：</p><p>这是要使用代理模式，为真正的Connection对象创建一个代理对象，代理对象所有的方法都是调用相应的真正Connection对象的方法实现。当代理对象执行close()方法时，要特殊处理，不调用真正Connection对象的close()方法，而是将Connection对象添加到连接池中。</p><p>MyBatis的PooledDataSource的PoolState内部维护的对象是PooledConnection类型的对象，而PooledConnection则是对真正的数据库连接java.sql.Connection实例对象的包裹器。</p><p>PooledConnection对象内持有一个真正的数据库连接java.sql.Connection实例对象和一个java.sql.Connection的代理，其部分定义如下：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">class</span> <span class="token class-name">PooledConnection</span> <span class="token keyword">implements</span> <span class="token class-name">InvocationHandler</span> <span class="token punctuation">{</span>  
   
    <span class="token comment">//......  </span>
    <span class="token comment">//所创建它的datasource引用  </span>
    <span class="token keyword">private</span> <span class="token class-name">PooledDataSource</span> dataSource<span class="token punctuation">;</span>  
    <span class="token comment">//真正的Connection对象  </span>
    <span class="token keyword">private</span> <span class="token class-name">Connection</span> realConnection<span class="token punctuation">;</span>  
    <span class="token comment">//代理自己的代理Connection  </span>
    <span class="token keyword">private</span> <span class="token class-name">Connection</span> proxyConnection<span class="token punctuation">;</span>  
   
    <span class="token comment">//......  </span>
<span class="token punctuation">}</span> 

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>PooledConenction实现了InvocationHandler接口，并且，proxyConnection对象也是根据这个它来生成的代理对象：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">PooledConnection</span><span class="token punctuation">(</span><span class="token class-name">Connection</span> connection<span class="token punctuation">,</span> <span class="token class-name">PooledDataSource</span> dataSource<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
   <span class="token keyword">this</span><span class="token punctuation">.</span>hashCode <span class="token operator">=</span> connection<span class="token punctuation">.</span><span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
   <span class="token keyword">this</span><span class="token punctuation">.</span>realConnection <span class="token operator">=</span> connection<span class="token punctuation">;</span>  
   <span class="token keyword">this</span><span class="token punctuation">.</span>dataSource <span class="token operator">=</span> dataSource<span class="token punctuation">;</span>  
   <span class="token keyword">this</span><span class="token punctuation">.</span>createdTimestamp <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
   <span class="token keyword">this</span><span class="token punctuation">.</span>lastUsedTimestamp <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
   <span class="token keyword">this</span><span class="token punctuation">.</span>valid <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>  
   <span class="token keyword">this</span><span class="token punctuation">.</span>proxyConnection <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Connection</span><span class="token punctuation">)</span> <span class="token class-name">Proxy</span><span class="token punctuation">.</span><span class="token function">newProxyInstance</span><span class="token punctuation">(</span><span class="token class-name">Connection</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">IFACES</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token punctuation">}</span> 

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>实际上，我们调用PooledDataSource的getConnection()方法返回的就是这个proxyConnection对象。当我们调用此proxyConnection对象上的任何方法时，都会调用PooledConnection对象内invoke()方法。</p><p>让我们看一下PooledConnection类中的invoke()方法定义：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">invoke</span><span class="token punctuation">(</span><span class="token class-name">Object</span> proxy<span class="token punctuation">,</span> <span class="token class-name">Method</span> method<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>  
    <span class="token class-name">String</span> methodName <span class="token operator">=</span> method<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token comment">//当调用关闭的时候，回收此Connection到PooledDataSource中  </span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">CLOSE</span><span class="token punctuation">.</span><span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> methodName<span class="token punctuation">.</span><span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token constant">CLOSE</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>methodName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  
        dataSource<span class="token punctuation">.</span><span class="token function">pushConnection</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>  
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>  
        <span class="token keyword">try</span> <span class="token punctuation">{</span>  
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>method<span class="token punctuation">.</span><span class="token function">getDeclaringClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  
                <span class="token function">checkConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
            <span class="token punctuation">}</span>  
            <span class="token keyword">return</span> method<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>realConnection<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>  
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
            <span class="token keyword">throw</span> <span class="token class-name">ExceptionUtil</span><span class="token punctuation">.</span><span class="token function">unwrapThrowable</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>  
        <span class="token punctuation">}</span>  
    <span class="token punctuation">}</span>  
<span class="token punctuation">}</span>  
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>从上述代码可以看到，当我们使用了pooledDataSource.getConnection()返回的Connection对象的close()方法时，不会调用真正Connection的close()方法，而是将此Connection对象放到连接池中。</p><h2 id="_8-jndi类型的数据源datasource" tabindex="-1"><a class="header-anchor" href="#_8-jndi类型的数据源datasource" aria-hidden="true">#</a> 8. JNDI类型的数据源DataSource</h2><p>对于JNDI类型的数据源DataSource的获取就比较简单，MyBatis定义了一个JndiDataSourceFactory工厂来创建通过JNDI形式生成的DataSource。下面让我们看一下JndiDataSourceFactory的关键代码：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>properties<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span><span class="token constant">INITIAL_CONTEXT</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> properties<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span><span class="token constant">DATA_SOURCE</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  
<span class="token punctuation">{</span>  
    <span class="token comment">//从JNDI上下文中找到DataSource并返回  </span>
    <span class="token class-name">Context</span> ctx <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Context</span><span class="token punctuation">)</span> initCtx<span class="token punctuation">.</span><span class="token function">lookup</span><span class="token punctuation">(</span>properties<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token constant">INITIAL_CONTEXT</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    dataSource <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">DataSource</span><span class="token punctuation">)</span> ctx<span class="token punctuation">.</span><span class="token function">lookup</span><span class="token punctuation">(</span>properties<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token constant">DATA_SOURCE</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token punctuation">}</span>  
<span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>properties<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span><span class="token constant">DATA_SOURCE</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  
<span class="token punctuation">{</span>  
    <span class="token comment">//从JNDI上下文中找到DataSource并返回  </span>
    dataSource <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">DataSource</span><span class="token punctuation">)</span> initCtx<span class="token punctuation">.</span><span class="token function">lookup</span><span class="token punctuation">(</span>properties<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token constant">DATA_SOURCE</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token punctuation">}</span> 

  
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="参考文章" tabindex="-1"><a class="header-anchor" href="#参考文章" aria-hidden="true">#</a> 参考文章</h2><p><a href="https://pdai.tech/md/framework/orm-mybatis/mybatis-y-datasource.html" target="_blank" rel="noopener noreferrer"><strong>MyBatis详解 - 数据源与连接池</strong><span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p></div><!----><footer class="page-meta"><div class="meta-item edit-link"><a href="https://github.com/zszdevelop/java-study-gitbook/edit/main/docs/dependencies/mybatis/mybatis-y-datasource.md" rel="noopener noreferrer" target="_blank" aria-label="编辑此页" class="nav-link label"><!--[--><svg xmlns="http://www.w3.org/2000/svg" class="icon edit-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="edit icon"><path d="M430.818 653.65a60.46 60.46 0 0 1-50.96-93.281l71.69-114.012 7.773-10.365L816.038 80.138A60.46 60.46 0 0 1 859.225 62a60.46 60.46 0 0 1 43.186 18.138l43.186 43.186a60.46 60.46 0 0 1 0 86.373L588.879 565.55l-8.637 8.637-117.466 68.234a60.46 60.46 0 0 1-31.958 11.229z"></path><path d="M728.802 962H252.891A190.883 190.883 0 0 1 62.008 771.98V296.934a190.883 190.883 0 0 1 190.883-192.61h267.754a60.46 60.46 0 0 1 0 120.92H252.891a69.962 69.962 0 0 0-69.098 69.099V771.98a69.962 69.962 0 0 0 69.098 69.098h475.911A69.962 69.962 0 0 0 797.9 771.98V503.363a60.46 60.46 0 1 1 120.922 0V771.98A190.883 190.883 0 0 1 728.802 962z"></path></svg><!--]-->编辑此页<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!----></a></div><div class="meta-item update-time"><span class="label">上次编辑于: </span><!----></div><div class="meta-item contributors"><span class="label">贡献者: </span><!--[--><!--[--><span class="contributor" title="email: zszdevelop@163.com">zszdevelop</span><!--]--><!--]--></div></footer><nav class="page-nav"><a href="/dependencies/mybatis/mybatis-y-plugin-page.html" class="nav-link prev" aria-label="MyBatis详解 - 插件之分页机制"><div class="hint"><span class="arrow left"></span>上一页</div><div class="link"><!---->MyBatis详解 - 插件之分页机制</div></a><a href="/dependencies/mybatis/mybatis-y-trans.html" class="nav-link next" aria-label="MyBatis详解 - 事务管理机制"><div class="hint">下一页<span class="arrow right"></span></div><div class="link">MyBatis详解 - 事务管理机制<!----></div></a></nav><div class="giscus-wrapper input-top" style="display:block;"><div style="text-align:center">Loading...</div></div><!----><!--]--></main><!--]--><footer class="footer-wrapper"><div class="footer"><a href='https://beian.miit.gov.cn' target='_blank' style='color: var(--c-text-lighter);>闽ICP备18001806号-1</a></div><div class="copyright">Copyright © 2024 zszdevelop</div></footer><!--]--></div><!--]--><!----><!--]--></div>
    <script type="module" src="/assets/app-891e5fab.js" defer></script>
  </body>
</html>
