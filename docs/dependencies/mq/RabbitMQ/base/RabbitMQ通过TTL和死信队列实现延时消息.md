# RabbitMQ通过TTL和死信队列实现延时消息队列

## 1. 延时消息使用场景

1. 未付款的订单，15分钟后关闭
2. 家里有一台智能热水器，需要在30分钟后启动
3. 新用户注册之后一个月没有下单，发个短信勾引一波
4. 涉及到T+d（工作日延迟）或者D+d（自然日延迟）等延迟交付的场景

### 1.1 为什么不使用定时任务轮询

虽然能同样能完成任务，但是业务数据量大的情况，对**服务器的压力大**，并且**误差大**

## 2. 实现背景

**rabbitmq本身是不直接支持延时队列的**，RabbitMQ的延迟队列基于消息的存活时间TTL（Time To Live）和死信交换机DLE（Dead Letter Exchanges）实现：

1. TTL：RabbitMQ可以对队列和消息各自设置存活时间，规则是两者中较小的值，即队列无消费者连接的消息过期时间，或者消息在队列中一直未被消费的过期时间
2. DLE：过期的消息通过绑定的死信交换机，路由到指定的死信队列，消费者实际上消费的是死信队列上的消息

## 3. 代码实现

[RabbitMQ场景-商城下单，超时取消订单](./scene/RabbitMQ场景-商城下单，超时取消订单.md)

## 参考文章

[RabbitMQ延迟队列](https://juejin.im/post/6844904163168485383)